<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>KTS Simulator (Home + Menu + Search)</title>

<style>
  :root{
    --bg:#02040a;
    --panel:#050a14;
    --blue1:#2e66d6;
    --blueGlow: rgba(60,150,255,.35);
    --white:#eaf0ff;
    --muted:#a9b9dd;

    --green:#39e36a;
    --red:#ff3b3b;

    --segOff:#2f3a46;
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    padding:22px;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background:#0b1220;
    display:flex;
    justify-content:center;
    color:var(--white);
  }
  .wrap{width:980px}
  h2{
    margin:0 0 12px 0;
    text-align:center;
    color:var(--muted);
    font-weight:800
  }

  /* ===== SEARCH PANEL (outside KTS) ===== */
  .searchPanel{
    max-width:980px;
    margin:0 auto 14px auto;
    display:flex;
    gap:12px;
    align-items:flex-start;
  }
  .searchBox{
    flex:1;
    background:rgba(0,0,0,.18);
    border:1px solid rgba(255,255,255,.12);
    border-radius:14px;
    padding:12px;
    box-shadow:0 10px 40px rgba(0,0,0,.25);
  }
  .searchRow{
    display:flex;
    gap:10px;
    align-items:center;
  }
  .searchRow input{
    flex:1;
    background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.14);
    border-radius:12px;
    padding:10px 12px;
    color:var(--white);
    outline:none;
    font-weight:700;
  }
  .searchRow input::placeholder{color:rgba(234,240,255,.55)}
  .searchRow button{
    border:1px solid rgba(255,255,255,.14);
    background:linear-gradient(180deg, rgba(45,97,199,.9), rgba(26,63,143,.9));
    color:var(--white);
    padding:10px 12px;
    border-radius:12px;
    font-weight:900;
    cursor:pointer;
    min-width:110px;
    font-size:12px;
  }
  .searchHint{
    margin-top:8px;
    font-size:12px;
    color:var(--muted);
    line-height:1.35;
  }

  .results{
    margin-top:10px;
    max-height:240px;
    overflow:auto;
    border-top:1px solid rgba(255,255,255,.10);
    padding-top:10px;
    display:none;
  }
  .results.active{display:block;}
  .resItem{
    padding:10px 10px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(0,0,0,.14);
    border-radius:12px;
    cursor:pointer;
    display:flex;
    flex-direction:column;
    gap:6px;
    margin-bottom:8px;
  }
  .resItem:hover{
    background:rgba(43,74,134,.25);
    border-color:rgba(255,255,255,.18)
  }
  .resTitle{font-weight:900}
  .resPath{
    font-size:12px;
    color:var(--muted);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .pill{
    display:inline-block;
    font-size:11px;
    padding:2px 8px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.06);
    color:var(--muted);
    width:max-content;
  }

  /* ===== KTS styles ===== */
  .kts{
    width: 560px;
    border-radius:18px;
    background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
    box-shadow:0 18px 70px rgba(0,0,0,.50);
    overflow:hidden;
    border:1px solid rgba(255,255,255,.10);
  }

  /* OFF blackout */
  .kts.off-state{ background:#000; }
  .kts.off-state .topbar,
  .kts.off-state .footer{ display:none; }
  .kts.off-state .screen{ background:#000; }
  .kts.off-state .home{
    background:#000;
    border-color:#000;
    box-shadow:none;
  }
  .kts.off-state .box,
  .kts.off-state .menuBtn,
  .kts.off-state .datetime{
    border-color:#000 !important;
    box-shadow:none !important;
    background:#000 !important;
    color:transparent !important;
  }
  .kts.off-state .tempBox .label,
  .kts.off-state .pct{ color:transparent !important; }
  .kts.off-state .segments span{ background:#000 !important; box-shadow:none !important; }
  .kts.off-state .kbtn{ visibility:hidden; pointer-events:none; }

  .kts.off-state .powerBox{
    border:0 !important;
    box-shadow:none !important;
    background:#000 !important;
  }
  .kts.off-state .powerBtn{
    opacity:1 !important;
    pointer-events:auto !important;
    border-color: var(--blue1) !important;
    box-shadow: 0 0 0 1px rgba(255,255,255,.05) inset !important;
    background: rgba(0,0,0,.12) !important;
  }

  .topbar{
    padding:10px 12px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    border-bottom:1px solid rgba(255,255,255,.10);
    background:rgba(0,0,0,.18);
    font-size:12px;
  }
  .where{font-weight:900}
  .path{
    color:var(--muted);
    max-width:70%;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
  }

  .screen{
    padding:14px;
    background: radial-gradient(600px 260px at 50% 0%, rgba(30,60,120,.35), rgba(0,0,0,.25));
    min-height: 430px;
  }

  .px{
    font-family: Consolas, "Courier New", monospace;
    letter-spacing: .6px;
    font-weight:900;
    text-transform:uppercase;
  }

  .home{
    width: 100%;
    aspect-ratio: 4 / 3;
    background: linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.25));
    border:2px solid var(--blue1);
    box-shadow: 0 0 0 2px rgba(255,255,255,.04) inset, 0 0 18px var(--blueGlow);
    padding:12px;
    display:grid;
    grid-template-columns: 1fr 230px;
    grid-template-rows: 1fr 70px;
    gap:10px;
    overflow:hidden;
  }

  .box{
    border:2px solid var(--blue1);
    box-shadow: 0 0 0 1px rgba(255,255,255,.05) inset;
    background: rgba(0,0,0,.22);
    overflow:hidden;
  }

  .leftArea{
    display:grid;
    grid-template-rows: 120px 1fr;
    gap:10px;
  }

  .powerBox{
    display:flex;
    align-items:center;
    padding:10px;
    gap:10px;
  }

  .kbtn{
    border:2px solid var(--blue1);
    background: linear-gradient(180deg, #2d61c7, #1a3f8f);
    box-shadow: 0 0 0 1px rgba(255,255,255,.06) inset;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    user-select:none;
    border-radius:10px;
  }
  .kbtn:active{transform:translateY(1px)}
  .kbtn.disabled{ opacity:.45; cursor:not-allowed; filter:saturate(.6); }

  .powerBtn{
    width:96px;
    height:96px;
    background: rgba(0,0,0,.12);
    border-radius:14px;
    border:2px solid var(--blue1);
    box-shadow: 0 0 0 1px rgba(255,255,255,.05) inset;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    user-select:none;
  }
  .powerBtn:active{transform:translateY(1px)}

  .tempBox{ padding:12px; display:flex; align-items:center; }
  .tempBox .label{ font-size:22px; line-height:1.1; white-space:pre-line; }

  .speedBox{
    padding:10px;
    display:grid;
    grid-template-columns: 1fr 64px;
    grid-template-rows: 1fr 24px;
    gap:10px;
    align-items:center;
    overflow:hidden;
  }

  .speed-wedge{
    width: 100%;
    height: 180px;
    background: rgba(0,0,0,.18);
    border:2px solid rgba(255,255,255,.08);
    border-radius: 6px;
    padding: 10px 10px 6px 10px;
    display:flex;
    flex-direction:column;
    overflow:hidden;
  }

  .segments{
    flex:1;
    width:100%;
    display:flex;
    flex-direction:column;
    align-items:flex-start;
    justify-content:space-between;
    padding-top:2px;
    overflow:hidden;
  }

  .segments span{
    height: 6px;
    border-radius: 2px;
    background: var(--segOff);
    opacity:.95;
    max-width:100%;
  }
  .segments span.active{
    background: var(--green);
    box-shadow: 0 0 5px rgba(57,227,106,.35);
  }

  .arrows{
    display:flex;
    flex-direction:column;
    gap:14px;
    align-items:stretch;
    justify-content:center;
  }
  .arrowBtn{ height:62px; border-radius:10px; }
  .tri{
    width:0;height:0;
    border-left:12px solid transparent;
    border-right:12px solid transparent;
  }
  .tri.up{border-bottom:18px solid rgba(255,255,255,.92)}
  .tri.down{border-top:18px solid rgba(255,255,255,.92)}

  .pct{
    grid-column: 1 / 3;
    text-align:center;
    font-size:14px;
    color:var(--muted);
  }

  .menuBtn{
    border:2px solid var(--blue1);
    background: linear-gradient(180deg, #2d61c7, #1a3f8f);
    box-shadow: 0 0 0 1px rgba(255,255,255,.06) inset;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:22px;
    font-weight:900;
    user-select:none;
  }
  .menuBtn:active{transform:translateY(1px)}

  .datetime{
    padding:10px 12px;
    display:flex;
    flex-direction:column;
    justify-content:center;
    gap:6px;
    color:var(--muted);
    text-align:right;
    font-size:14px;
  }

  .grid{ display:flex; flex-direction:column; gap:8px; }
  .item{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding:10px 10px;
    border:1px solid rgba(255,255,255,.10);
    border-radius:12px;
    background:rgba(0,0,0,.16);
    cursor:pointer;
    user-select:none;
  }
  .item:hover{
    background:rgba(43,74,134,.25);
    border-color:rgba(255,255,255,.18)
  }
  .item .label{font-weight:800}
  .item .hint{font-size:12px; color:var(--muted)}
  .right{
    font-size:12px;
    color:var(--muted);
    display:flex;
    align-items:center;
    gap:8px;
  }
  .dot{width:8px; height:8px; border-radius:999px; background:rgba(255,255,255,.22)}
  .dot.leaf{background:rgba(71,224,122,.85)}
  .dot.node{background:rgba(100,170,255,.75)}

  .footer{
    border-top:1px solid rgba(255,255,255,.10);
    background:rgba(0,0,0,.18);
    padding:10px 12px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .btnrow{ display:flex; gap:8px; flex-wrap:wrap }
  .footer button{
    border:1px solid rgba(255,255,255,.14);
    background:linear-gradient(180deg, rgba(45,97,199,.9), rgba(26,63,143,.9));
    color:var(--white);
    padding:9px 10px;
    border-radius:12px;
    font-weight:900;
    cursor:pointer;
    min-width:72px;
    font-size:12px;
  }
  .footer button.secondary{
    background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
  }
  .footer button:disabled{opacity:.45; cursor:not-allowed}
  .status{
    font-size:12px;
    color:var(--muted);
    display:flex;
    align-items:center;
    gap:8px;
  }
  .badge{
    font-size:12px;
    padding:2px 8px;
    border:1px solid rgba(255,255,255,.14);
    border-radius:999px;
    background:rgba(255,255,255,.06);
  }
</style>
</head>

<body>
<div class="wrap">
  <h2>KTS — Simulator</h2>

  <!-- SEARCH OUTSIDE KTS -->
  <div class="searchPanel">
    <div class="searchBox">
      <div class="searchRow">
        <input id="searchInput" type="text" placeholder="Cerca schermata... es: Probes settings, Climate settings, Fire alarm..." />
        <button id="searchClear">CLEAR</button>
      </div>
      <div class="searchHint">
        - Scrivi 2+ caratteri per vedere i risultati.<br/>
        - Clicca un risultato per aprire direttamente la schermata e vedere il percorso completo.<br/>
        - Se l’unità è OFF (blackout), la navigazione viene bloccata: riaccendi con il tasto power.
      </div>

      <div class="results" id="results"></div>
    </div>
  </div>

  <div class="kts" id="ktsRoot" role="application" aria-label="KTS Simulator">
    <div class="topbar">
      <div class="where" id="where">HOME</div>
      <div class="path" id="path">HOME</div>
    </div>

    <div class="screen" id="screen"></div>

    <div class="footer">
      <div class="btnrow">
        <button id="btnHome">HOME</button>
        <button id="btnBack" class="secondary">BACK</button>
        <button id="btnPrev" class="secondary">&lt;&lt;</button>
        <button id="btnNext" class="secondary">&gt;&gt;</button>
        <button id="btnOk">OK</button>
      </div>
      <div class="status">
        <span class="badge" id="count">—</span>
        <span class="badge" id="sel">Selected: —</span>
      </div>
    </div>
  </div>
</div>

<script>
/* --------------------------
   DATA MODEL (tree)
-------------------------- */
function node(name, children = [], opts = {}) {
  return { name, children, ...opts };
}

const SettingsP1 = node("Settings (Page 1/2)", [
  node("Language settings"),
  node("Screensaver"),
  node("Date and time settings"),
  node("Weekly settings", [
    node("ON / OFF"),
    node("Program", [
      node("Days (Sunday - Saturday)"),
      node("Back"),
      node("Copy"),
      node("Paste"),
      node("Prog", [
        node("Up to 4 time ranges"),
        node("Start / Stop time"),
        node("Fan speed per range")
      ])
    ]),
    node("View"),
    node("Seasonal icons", [
      node("Snowflake (Summer mode)", [
        node("Day setpoint summer"),
        node("Night setpoint summer")
      ]),
      node("Sun (Winter mode)", [
        node("Day setpoint winter"),
        node("Night setpoint winter")
      ])
    ]),
    node("Speed")
  ])
], { pageGroup:"settings", pageIndex:1, pageTotal:2 });

const SettingsP2 = node("Settings (Page 2/2)", [
  node("Climate settings", [
    node("Seasonal icons", [
      node("Snowflake (Summer mode)", [ node("Temp setpoint summer") ]),
      node("Sun (Winter mode)", [ node("Temp setpoint winter") ])
    ])
  ]),
  node("Party settings"),
  node("Password settings"),
  node("Set RFM channel")
], { pageGroup:"settings", pageIndex:2, pageTotal:2 });

const InputSettings = node("Input settings", [
  node("Page 1/3", [
    node("Enable / Disable"),
    node("Regulation air flow (0–10 V)"),
    node("Input channel (INPUT 1 / INPUT 2)")
  ], { pageGroup:"input", pageIndex:1, pageTotal:3 }),
  node("Page 2/3", [
    node("Enable / Disable"),
    node("Season toggle (Summer / Winter)", [
      node("0 V = winter"),
      node("10 V = summer")
    ]),
    node("Target UNIT (fan)"),
    node("Target BPD (bypass damper)")
  ], { pageGroup:"input", pageIndex:2, pageTotal:3 }),
  node("Page 3/3", [
    node("Enable / Disable"),
    node("Fire alarm behavior", [
      node("Stop extract + stop supply"),
      node("Start extract + stop supply"),
      node("Stop extract + start supply"),
      node("Start extract + start supply")
    ])
  ], { pageGroup:"input", pageIndex:3, pageTotal:3 })
]);

const ServiceP1 = node("Page 1/6", [
  node("Disconnect accessories"),
  node("Ventilation control", [
    node("CAF"),
    node("FSC"),
    node("CAP"),
    node("CAP calibration procedure")
  ]),
  node("Airflow settings", [
    node("Three speeds"),
    node("Stepless (speed)")
  ]),
  InputSettings
], { pageGroup:"service", pageIndex:1, pageTotal:6 });

const Service = node("Service (password required)", [
  ServiceP1,
  node("Page 2/6", [
    node("Output settings"),
    node("BPD settings"),
    node("Unbalanced airflow"),
    node("Filter settings")
  ], { pageGroup:"service", pageIndex:2, pageTotal:6 }),
  node("Page 3/6", [
    node("RH settings"),
    node("CO2 settings"),
    node("VOC settings"),
    node("Temperature hysteresis")
  ], { pageGroup:"service", pageIndex:3, pageTotal:6 }),
  node("Page 4/6", [
    node("Report data (admin)"),
    node("Upgrade"),
    node("Change password"),
    node("Probes settings", [
      node("Temperature probe settings", [
        node("Return"),
        node("Supply")
      ])
    ])
  ], { pageGroup:"service", pageIndex:4, pageTotal:6 }),
  node("Page 5/6", [
    node("Modbus settings"),
    node("Test unit"),
    node("EEPROM reset"),
    node("Reference temperature settings")
  ], { pageGroup:"service", pageIndex:5, pageTotal:6 }),
  node("Page 6/6", [
    node("DSC update delay"),
    node("PIR settings"),
    node("Clean event settings")
  ], { pageGroup:"service", pageIndex:6, pageTotal:6 })
]);

const Info = node("Info", [
  node("Page 1/3", [
    node("Device ID"),
    node("Serial ID"),
    node("Firmware version"),
    node("Software version"),
    node("Hardware version"),
    node("Unit type"),
    node("KTS type (Basic / Extra)"),
    node("Counter"),
    node("Probes")
  ], { pageGroup:"info", pageIndex:1, pageTotal:3 }),
  node("Page 2/3", [ node("QR code (unit summary)") ], { pageGroup:"info", pageIndex:2, pageTotal:3 }),
  node("Page 3/3", [
    node("Accessories list", [
      node("HWD"),
      node("MBUS"),
      node("BPD"),
      node("CWD"),
      node("DPP V2"),
      node("INP"),
      node("OUT"),
      node("EPBD"),
      node("CAPS"),
      node("CAPR")
    ])
  ], { pageGroup:"info", pageIndex:3, pageTotal:3 })
]);

const MENU = node("MENU", [ SettingsP1, SettingsP2, Service, Info ]);
const HOME = node("HOME", [ MENU ]);

/* --------------------------
   NAV STATE
-------------------------- */
let stack = [HOME];
let selectedIndex = 0;

/* --------------------------
   HOME simulated values
-------------------------- */
let unitOn = true;
let tLabel = "T. RETOUR";
let tValue = 15;
let speedPct = 20;

/* --------------------------
   Helpers
-------------------------- */
function current(){ return stack[stack.length-1]; }
function kids(n){ return n.children || []; }
function isLeaf(n){ return !n.children || n.children.length===0; }
function pathText(){ return stack.map(x=>x.name).join(" \u2192 "); }
function clampSel(){
  const k = kids(current());
  if(k.length===0){ selectedIndex=0; return; }
  selectedIndex = Math.max(0, Math.min(selectedIndex, k.length-1));
}

/* Wedge segments: fill from bottom, right trapezoid */
function buildWedgeSegmentsHTML(segmentCount, pct){
  const activeCount = Math.round((pct/100) * segmentCount);
  const topW = 1.00;
  const bottomW = 0.22;

  let s = "";
  for(let i=0;i<segmentCount;i++){
    const isOn = i >= (segmentCount - activeCount);
    const w = topW - (i * (topW - bottomW) / (segmentCount - 1));
    s += `<span class="${isOn ? 'active' : ''}" style="width:${(w*100).toFixed(1)}%"></span>`;
  }
  return s;
}

/* OFF blackout */
function syncOffState(){
  const root = document.getElementById("ktsRoot");
  if(!unitOn) root.classList.add("off-state");
  else root.classList.remove("off-state");
}

/* --------------------------
   Render HOME
-------------------------- */
function renderHome(){
  const screen = document.getElementById("screen");

  const timeText = "05:05  MAR";
  const dateText = "25/03/2040";
  const strokeColor = unitOn ? "var(--green)" : "var(--red)";
  const segCount = 22;

  screen.innerHTML = `
    <div class="home">
      <div class="leftArea">
        <div class="box powerBox">
          <div class="powerBtn" id="pwrBtn" title="Power ON/OFF">
            <svg viewBox="0 0 64 64" aria-label="Power" style="width:78px;height:78px">
              <circle cx="32" cy="32" r="23" fill="none" stroke="${strokeColor}" stroke-width="8"/>
              <line x1="32" y1="10" x2="32" y2="29" stroke="${strokeColor}" stroke-width="8" stroke-linecap="round"/>
            </svg>
          </div>
        </div>

        <div class="box tempBox">
          <div class="px label">${tLabel}\n${tValue} °C</div>
        </div>
      </div>

      <div class="box speedBox">
        <div class="speed-wedge" aria-label="Speed wedge">
          <div class="segments" id="segments">
            ${buildWedgeSegmentsHTML(segCount, unitOn ? speedPct : 0)}
          </div>
        </div>

        <div class="arrows">
          <div class="kbtn arrowBtn ${unitOn ? '' : 'disabled'}" id="spdUp"><div class="tri up"></div></div>
          <div class="kbtn arrowBtn ${unitOn ? '' : 'disabled'}" id="spdDn"><div class="tri down"></div></div>
        </div>

        <div class="pct px" id="pctLabel">${unitOn ? speedPct : 0} %</div>
      </div>

      <div class="menuBtn px" id="homeMenu">MENU</div>

      <div class="box datetime px">
        <div>${timeText}</div>
        <div>${dateText}</div>
      </div>
    </div>
  `;

  document.getElementById("homeMenu").addEventListener("click", () => {
    if(!unitOn) return;
    stack.push(MENU);
    selectedIndex = 0;
    render();
  });

  document.getElementById("pwrBtn").addEventListener("click", () => {
    unitOn = !unitOn;
    if(!unitOn) speedPct = 0;
    syncOffState();
    renderHome();
    updateButtons();
    // Search navigation is blocked in OFF (handled in goToPath)
  });

  document.getElementById("spdUp").addEventListener("click", () => {
    if(!unitOn) return;
    speedPct = Math.min(100, speedPct + 5);
    renderHome();
  });
  document.getElementById("spdDn").addEventListener("click", () => {
    if(!unitOn) return;
    speedPct = Math.max(0, speedPct - 5);
    renderHome();
  });
}

/* --------------------------
   Render LIST
-------------------------- */
function renderList(){
  const screen = document.getElementById("screen");
  const where = document.getElementById("where");
  const path = document.getElementById("path");
  const count = document.getElementById("count");
  const sel = document.getElementById("sel");

  where.textContent = current().name;
  path.textContent = pathText();

  const k = kids(current());
  clampSel();

  count.textContent = `${k.length} item(s)`;
  sel.textContent = `Selected: ${k[selectedIndex] ? k[selectedIndex].name : "—"}`;

  if(k.length===0){
    screen.innerHTML = `
      <div class="grid">
        <div class="item" style="cursor:default">
          <div>
            <div class="label">No items</div>
            <div class="hint">Use BACK to go up</div>
          </div>
          <div class="right"><span class="dot leaf"></span></div>
        </div>
      </div>
    `;
    updateButtons();
    return;
  }

  let html = `<div class="grid">`;
  k.forEach((c, idx) => {
    const dot = isLeaf(c) ? "dot leaf" : "dot node";
    const hint = isLeaf(c) ? "Leaf" : `${kids(c).length} sub-item(s)`;
    const enterTxt = isLeaf(c) ? "" : "Enter →";
    html += `
      <div class="item" data-idx="${idx}">
        <div>
          <div class="label">${c.name}</div>
          <div class="hint">${hint}</div>
        </div>
        <div class="right">
          <span class="${dot}"></span>
          <span>${enterTxt}</span>
        </div>
      </div>
    `;
  });
  html += `</div>`;
  screen.innerHTML = html;

  screen.querySelectorAll(".item").forEach(it=>{
    it.addEventListener("click", ()=>{
      selectedIndex = parseInt(it.getAttribute("data-idx"),10);
      const chosen = kids(current())[selectedIndex];
      if(chosen && !isLeaf(chosen)) enterSelected();
      else render();
    });
  });

  updateButtons();
}

/* --------------------------
   Main render
-------------------------- */
function render(){
  const where = document.getElementById("where");
  const path = document.getElementById("path");

  where.textContent = current().name;
  path.textContent = pathText();

  if(current() === HOME){
    document.getElementById("count").textContent = "—";
    document.getElementById("sel").textContent = "Selected: —";
    syncOffState();
    renderHome();
    updateButtons();
    return;
  }
  renderList();
}

/* --------------------------
   Navigation
-------------------------- */
function goHome(){ if(!unitOn) return; stack = [HOME]; selectedIndex = 0; render(); }
function goBack(){ if(!unitOn) return; if(stack.length>1){ stack.pop(); selectedIndex=0; render(); } }
function enterSelected(){
  if(!unitOn) return;
  const k = kids(current());
  const chosen = k[selectedIndex];
  if(chosen && !isLeaf(chosen)){
    stack.push(chosen);
    selectedIndex = 0;
    render();
  }
}
function pageStep(dir){
  if(!unitOn) return;
  const cur = current();
  if(stack.length < 2) return;

  const parent = stack[stack.length-2];
  const siblings = kids(parent);
  const idx = siblings.findIndex(s=>s===cur);
  if(idx<0 || !cur.pageGroup) return;

  const group = siblings
    .map((n,i)=>({n,i}))
    .filter(x=>x.n.pageGroup === cur.pageGroup)
    .sort((a,b)=>(a.n.pageIndex||0)-(b.n.pageIndex||0));

  const pos = group.findIndex(x=>x.n===cur);
  const nextPos = pos + dir;
  if(nextPos<0 || nextPos>=group.length) return;

  stack[stack.length-1] = group[nextPos].n;
  selectedIndex=0;
  render();
}
function updateButtons(){
  const btnBack = document.getElementById("btnBack");
  const btnHome = document.getElementById("btnHome");
  const btnPrev = document.getElementById("btnPrev");
  const btnNext = document.getElementById("btnNext");
  const btnOk   = document.getElementById("btnOk");

  btnBack.disabled = (!unitOn) || (stack.length <= 1);
  btnHome.disabled = (!unitOn) || (stack.length === 1);
  btnOk.disabled   = (!unitOn) || (current() === HOME) || (kids(current()).length === 0);

  let canPrev=false, canNext=false;
  if(unitOn && stack.length >= 2){
    const cur = current();
    const parent = stack[stack.length-2];
    if(cur.pageGroup){
      const siblings = kids(parent);
      const group = siblings
        .filter(n => n.pageGroup === cur.pageGroup)
        .sort((a,b)=>(a.pageIndex||0)-(b.pageIndex||0));
      const pos = group.findIndex(n=>n===cur);
      canPrev = group.length>1 && pos>0;
      canNext = group.length>1 && pos<group.length-1;
    }
  }
  btnPrev.disabled = !canPrev;
  btnNext.disabled = !canNext;
}

/* Buttons */
document.getElementById("btnHome").addEventListener("click", goHome);
document.getElementById("btnBack").addEventListener("click", goBack);
document.getElementById("btnOk").addEventListener("click", enterSelected);
document.getElementById("btnPrev").addEventListener("click", ()=>pageStep(-1));
document.getElementById("btnNext").addEventListener("click", ()=>pageStep(+1));

/* --------------------------
   SEARCH INDEX
-------------------------- */
let index = []; // { label, node, pathNodes, pathText, depth }

function buildIndex(){
  index = [];
  const root = HOME;

  function walk(n, pathNodes){
    const newPath = [...pathNodes, n];
    if(n !== HOME){ // exclude HOME from results if you want
      index.push({
        label: n.name,
        node: n,
        pathNodes: newPath,
        pathText: newPath.map(x=>x.name).join(" → "),
        depth: newPath.length
      });
    }
    (n.children || []).forEach(ch => walk(ch, newPath));
  }
  walk(root, []);
}

function normalize(s){
  return (s||"")
    .toLowerCase()
    .replace(/\s+/g," ")
    .trim();
}

function search(q){
  const qq = normalize(q);
  if(qq.length < 2) return [];
  return index
    .filter(r => normalize(r.label).includes(qq) || normalize(r.pathText).includes(qq))
    .sort((a,b) => a.depth - b.depth || a.label.localeCompare(b.label))
    .slice(0, 25);
}

/* Navigate directly to a path */
function goToPath(pathNodes){
  if(!unitOn) return; // blocked when OFF
  // pathNodes starts with HOME, then MENU, then...
  stack = [HOME];
  for(let i=1;i<pathNodes.length;i++){
    stack.push(pathNodes[i]);
  }
  selectedIndex = 0;
  render();
}

/* Search UI */
const searchInput = document.getElementById("searchInput");
const resultsEl = document.getElementById("results");
const searchClear = document.getElementById("searchClear");

function renderResults(list){
  if(list.length === 0){
    resultsEl.classList.remove("active");
    resultsEl.innerHTML = "";
    return;
  }
  resultsEl.classList.add("active");
  resultsEl.innerHTML = list.map((r, idx) => `
    <div class="resItem" data-idx="${idx}">
      <div class="resTitle">${r.label}</div>
      <div class="resPath">${r.pathText}</div>
      <div class="pill">Path available</div>
    </div>
  `).join("");

  resultsEl.querySelectorAll(".resItem").forEach(el=>{
    el.addEventListener("click", ()=>{
      const idx = parseInt(el.getAttribute("data-idx"),10);
      const picked = list[idx];
      if(!picked) return;
      goToPath(picked.pathNodes);
      // after jump show path in top bar automatically
    });
  });
}

searchInput.addEventListener("input", ()=>{
  const list = search(searchInput.value);
  renderResults(list);
});

searchInput.addEventListener("keydown", (e)=>{
  if(e.key === "Enter"){
    const list = search(searchInput.value);
    if(list.length > 0){
      goToPath(list[0].pathNodes);
    }
  }
});

searchClear.addEventListener("click", ()=>{
  searchInput.value = "";
  renderResults([]);
  searchInput.focus();
});

/* Init */
buildIndex();
render();
</script>
</body>
</html>
